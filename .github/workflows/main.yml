name: Main Pipeline
on: [push]
jobs:
  Style-Check:
    runs-on: ubuntu-latest
    steps:
      - name: "Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 
      - name: "Install Poetry"
        uses: abatilo/actions-poetry@v2.4.0
      - name: "Check out repository code"
        uses: "actions/checkout@v3"
      - name: "Install Dependencies"
        run: "scripts/install-deps.sh"
      - name: "Code Style Check"
        run: "scripts/format.sh"

  Unit-Test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        optional_deps: [0, 1]
    env:
      DAILYBKUP_DEV_OPTIONAL_DEPS: ${{ matrix.optional_deps }}
    steps:
      - name: "Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 
      - name: "Install Poetry"
        uses: abatilo/actions-poetry@v2.4.0
      - name: "Check out repository code"
        uses: "actions/checkout@v3"
      - name: "Install Dependencies"
        run: "scripts/install-deps.sh"
      - name: "Unit Tests"
        run: "scripts/test.sh -u"

  Functional-Test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        optional_deps: [0, 1]
    env:
      DAILYBKUP_DEV_OPTIONAL_DEPS: ${{ matrix.optional_deps }}
    services:
      wiremock:
        image: wiremock/wiremock:2.35.0
        ports:
          - 9000:8080
    steps:
      - name: "Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 
      - name: "Install Poetry"
        uses: abatilo/actions-poetry@v2.4.0
      - name: "Check out repository code"
        uses: "actions/checkout@v3"
      - name: "Install Dependencies"
        run: "scripts/install-deps.sh"
      - name: "Functional Tests"
        env:
          DAILYBKUP_B2_APPLICATION_KEY: ${{ secrets.DAILYBKUP_B2_APPLICATION_KEY }}
          DAILYBKUP_B2_APPLICATION_KEY_ID: ${{ secrets.DAILYBKUP_B2_APPLICATION_KEY_ID }}
        run: "scripts/test.sh -f"

  Type-Check:
    runs-on: ubuntu-latest
    steps:
      - name: "Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 
      - name: "Install Poetry"
        uses: abatilo/actions-poetry@v2.4.0
      - name: "Check out repository code"
        uses: "actions/checkout@v3"
      - name: "Install Dependencies"
        run: "scripts/install-deps.sh"
      - name: "Type Checking"
        run: "scripts/typecheck.sh"
